
import React, { useState, useCallback } from 'react';
import { AppState, StoryScenario, PanelData, FeedbackData, DifficultyLevel, SavedSession } from './types';
import * as GeminiService from './services/geminiService';
import * as StorageService from './services/storageService';
import Panel from './components/Panel';
import WritingArea from './components/WritingArea';
import { AlertCircle, BookOpen, CheckCircle, RefreshCw, GraduationCap, Save, History as HistoryIcon, Trash2, X, AlignLeft, Sparkles, Target, PenTool, ClipboardCheck } from 'lucide-react';

const App: React.FC = () => {
  const [appState, setAppState] = useState<AppState>(AppState.IDLE);
  const [difficulty, setDifficulty] = useState<DifficultyLevel>('P3');
  const [scenario, setScenario] = useState<StoryScenario | null>(null);
  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [studentText, setStudentText] = useState('');
  const [feedback, setFeedback] = useState<FeedbackData | null>(null);
  const [showMysteryEnding, setShowMysteryEnding] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // History/Session State
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const [showHistory, setShowHistory] = useState(false);
  const [savedSessions, setSavedSessions] = useState<SavedSession[]>([]);

  const handleGenerate = useCallback(async () => {
    try {
      setAppState(AppState.GENERATING_SCENARIO);
      setError(null);
      setScenario(null);
      setGeneratedImages([]);
      setStudentText('');
      setFeedback(null);
      setCurrentSessionId(null); // Reset session ID for new generation

      // 1. Generate Text Scenario with selected difficulty
      const newScenario = await GeminiService.generateScenario(difficulty);
      setScenario(newScenario);

      // 2. Generate Images
      setAppState(AppState.GENERATING_IMAGES);
      
      // Generate images in parallel for speed
      const imagePromises = newScenario.panels.map((panel) => 
        GeminiService.generatePanelImage(panel.description)
      );

      const images = await Promise.all(imagePromises);
      setGeneratedImages(images);
      
      setAppState(AppState.READY);
    } catch (err: any) {
      console.error(err);
      setError(err.message || "Something went wrong generating the comic.");
      setAppState(AppState.IDLE);
    }
  }, [difficulty]);

  const handleGrade = useCallback(async () => {
    if (!scenario) return;
    try {
      setAppState(AppState.GRADING);
      const result = await GeminiService.gradeStory(studentText, scenario);
      setFeedback(result);
      setAppState(AppState.READY);
    } catch (err: any) {
      setError("Failed to grade the story. Please try again.");
      setAppState(AppState.READY);
    }
  }, [studentText, scenario]);

  const handleSave = async () => {
    if (!scenario) return;
    try {
      const savedId = await StorageService.saveSession({
        scenario,
        generatedImages,
        studentText,
        feedback,
        difficulty
      }, currentSessionId || undefined);
      
      setCurrentSessionId(savedId); // Update current ID to ensure future saves update this record
      alert("Story saved to history!");
    } catch (e) {
      console.error(e);
      alert("Failed to save story. Please try again.");
    }
  };

  const openHistory = async () => {
    try {
      const sessions = await StorageService.getSessions();
      setSavedSessions(sessions);
      setShowHistory(true);
    } catch (e) {
      console.error(e);
      alert("Failed to load history.");
    }
  };

  const loadSession = (session: SavedSession) => {
    setScenario(session.scenario);
    setGeneratedImages(session.generatedImages);
    setStudentText(session.studentText);
    setFeedback(session.feedback);
    setDifficulty(session.difficulty);
    setCurrentSessionId(session.id); // Set the current ID so saving updates this session
    setAppState(AppState.READY);
    setShowHistory(false);
    setShowMysteryEnding(true); // Reset mystery ending view on load
  };

  const deleteSession = async (id: string) => {
    try {
      await StorageService.deleteSession(id);
      setSavedSessions(prev => prev.filter(s => s.id !== id));
      if (id === currentSessionId) {
        setCurrentSessionId(null);
      }
    } catch (e) {
      console.error(e);
      alert("Failed to delete story.");
    }
  };

  // Helper to get specific panel data safely
  const getPanelData = (index: number): PanelData | undefined => {
    return scenario?.panels[index];
  };

  const isBusy = appState === AppState.GENERATING_SCENARIO || appState === AppState.GENERATING_IMAGES || appState === AppState.GRADING;

  return (
    <div className="min-h-screen py-8 px-4 font-sans text-gray-800 relative">
      
      {/* Main Container (Paper Style) */}
      <main className="max-w-4xl mx-auto bg-white p-8 md:p-12 border border-gray-300 paper-shadow min-h-[800px]">
        
        {/* Header */}
        <header className="border-b-2 border-gray-800 pb-6 mb-8">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold font-serif flex items-center gap-2">
                <GraduationCap className="h-8 w-8 text-blue-900" />
                Part 4: Story Writing
              </h1>
              <p className="font-serif text-lg mt-1">
                {scenario 
                  ? scenario.title 
                  : "Select a level and click 'New Comic' to start."}
              </p>
            </div>

            <div className="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end">
               {/* History Button */}
               <button
                onClick={openHistory}
                disabled={isBusy}
                className="flex items-center gap-2 text-gray-600 hover:text-blue-700 px-3 py-2 rounded hover:bg-gray-100 transition-colors"
                title="Load saved stories"
              >
                <HistoryIcon className="h-5 w-5" />
                <span className="hidden sm:inline">History</span>
              </button>

              {/* Save Button (Only if scenario exists) */}
              {scenario && (
                <button
                  onClick={handleSave}
                  disabled={isBusy}
                  className="flex items-center gap-2 text-gray-600 hover:text-green-700 px-3 py-2 rounded hover:bg-gray-100 transition-colors"
                  title="Save current progress"
                >
                  <Save className="h-5 w-5" />
                  <span className="hidden sm:inline">Save</span>
                </button>
              )}

              {/* Difficulty Selector */}
              <div className="flex bg-gray-100 p-1 rounded-lg border border-gray-200">
                <button 
                  onClick={() => setDifficulty('P3')}
                  disabled={isBusy}
                  className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${
                    difficulty === 'P3' 
                      ? 'bg-white text-blue-600 shadow-sm' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  P3 (30w)
                </button>
                <button 
                  onClick={() => setDifficulty('P5')}
                  disabled={isBusy}
                  className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${
                    difficulty === 'P5' 
                      ? 'bg-white text-blue-600 shadow-sm' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  P5 (70w)
                </button>
              </div>

              <button 
                onClick={handleGenerate}
                disabled={isBusy}
                className="w-full md:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:opacity-50 transition-colors font-semibold shadow-sm"
              >
                {appState === AppState.GENERATING_SCENARIO || appState === AppState.GENERATING_IMAGES ? (
                   <RefreshCw className="animate-spin h-4 w-4" />
                ) : (
                   <BookOpen className="h-4 w-4" />
                )}
                {appState === AppState.IDLE ? "Generate" : "New"}
              </button>
            </div>
          </div>
          
          {/* Instructions */}
          {scenario && (
            <div className="mt-4 bg-blue-50 p-4 rounded border border-blue-100">
              <ul className="list-disc list-inside font-serif text-sm text-gray-700 space-y-1">
                <li>Look at the pictures and write the story in about <strong>{scenario.difficulty === 'P5' ? '70' : '30'}</strong> words.</li>
                <li>You may use the words in the boxes to help you.</li>
                <li>What happens in the end? Finish the story.</li>
              </ul>
            </div>
          )}
        </header>

        {/* Error Message */}
        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-600 rounded flex items-center gap-2">
            <AlertCircle className="h-5 w-5" />
            {error}
          </div>
        )}

        {/* Loading State (Initial) */}
        {appState === AppState.IDLE && !scenario && (
          <div className="text-center py-20 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
            <p className="text-xl font-serif italic mb-2">Choose your level (P3 or P5)</p>
            <p className="text-sm">Then click "Generate" to begin your practice.</p>
          </div>
        )}

        {/* Comics Grid */}
        {(scenario || appState === AppState.GENERATING_SCENARIO) && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-12 max-w-3xl mx-auto my-8">
            
            {/* Panel 1 */}
            <Panel 
              id={1} 
              imageUrl={generatedImages[0]} 
              keywords={getPanelData(0)?.keywords || []} 
              isLoading={!generatedImages[0]} 
            />

            {/* Panel 2 */}
            <Panel 
              id={2} 
              imageUrl={generatedImages[1]} 
              keywords={getPanelData(1)?.keywords || []} 
              isLoading={!generatedImages[1]} 
            />

            {/* Panel 3 */}
            <Panel 
              id={3} 
              imageUrl={generatedImages[2]} 
              keywords={getPanelData(2)?.keywords || []} 
              isLoading={!generatedImages[2]} 
            />

            {/* Panel 4 (The Ending) */}
            <div className="relative group">
               {/* Toggle for Teacher/Student View */}
               {generatedImages[3] && (
                  <button 
                    onClick={() => setShowMysteryEnding(!showMysteryEnding)}
                    className="absolute -top-8 right-0 text-xs text-blue-500 underline hover:text-blue-700"
                  >
                    {showMysteryEnding ? "Show Answer" : "Hide Answer"}
                  </button>
               )}
               
               <Panel 
                id={4} 
                imageUrl={showMysteryEnding ? undefined : generatedImages[3]} 
                keywords={showMysteryEnding ? [] : (getPanelData(3)?.keywords || [])}
                isLoading={!generatedImages[3]}
                isQuestionMark={showMysteryEnding}
              />
            </div>

          </div>
        )}

        {/* Writing Section */}
        {scenario && appState === AppState.READY && (
           <>
             <WritingArea 
               value={studentText} 
               onChange={setStudentText} 
               disabled={false} 
               onSubmit={handleGrade}
               isGrading={false}
               difficulty={scenario.difficulty}
             />
           </>
        )}
        
        {/* Grading State */}
        {appState === AppState.GRADING && (
          <div className="mt-8 text-center text-gray-500 font-serif italic animate-pulse">
            Teacher is marking your work...
          </div>
        )}

        {/* Feedback Display */}
        {feedback && (
          <div className="mt-10 border-t-2 border-gray-200 pt-8 bg-yellow-50 p-6 rounded-lg border border-yellow-200 shadow-sm animate-fadeIn">
             {/* Header & Score */}
             <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
               <div className="flex items-center gap-3">
                 <div className="bg-green-100 p-2 rounded-full text-green-700">
                   <CheckCircle className="h-6 w-6" />
                 </div>
                 <h2 className="text-2xl font-serif font-bold text-gray-800">Assessment Report</h2>
               </div>
               
               {/* Score Badge */}
               <div className="flex items-center gap-4 bg-white px-6 py-3 rounded-lg shadow-sm border border-yellow-100">
                 <div className="text-center border-r border-gray-200 pr-4">
                    <span className="block text-xs font-bold text-gray-400 uppercase">Content</span>
                    <span className="text-xl font-bold text-gray-800">
                      {feedback.contentScore ?? '?'}/{feedback.maxScore === 7 ? 4 : 3}
                    </span>
                 </div>
                 <div className="text-center border-r border-gray-200 pr-4">
                    <span className="block text-xs font-bold text-gray-400 uppercase">Language</span>
                    <span className="text-xl font-bold text-gray-800">{feedback.languageScore ?? '?'}/3</span>
                 </div>
                 <div className="text-center pl-2">
                    <span className="block text-xs font-bold text-green-600 uppercase">Total</span>
                    <span className="text-3xl font-bold text-green-700">{feedback.score}/{feedback.maxScore}</span>
                 </div>
               </div>
             </div>
             
             {/* Encouragement */}
             <div className="mb-6">
                <p className="text-lg text-gray-800 italic border-l-4 border-green-500 pl-4 py-2 bg-white rounded shadow-sm">
                  "{feedback.encouragement}"
                </p>
             </div>

             <div className="grid md:grid-cols-2 gap-6">
                {/* Left Col: Core Corrections */}
                <div className="space-y-4">
                   <div className="bg-white p-5 rounded-lg border border-red-100 shadow-sm">
                      <h3 className="font-bold text-red-700 uppercase text-xs tracking-wider mb-3 flex items-center gap-2">
                        <PenTool className="h-4 w-4"/> Grammar & Language
                      </h3>
                      {feedback.grammarCorrections.length > 0 ? (
                        <ul className="list-disc list-inside text-sm text-gray-700 space-y-2">
                          {feedback.grammarCorrections.map((c, i) => <li key={i} className="leading-relaxed">{c}</li>)}
                        </ul>
                      ) : (
                        <p className="text-sm text-green-600 font-medium flex items-center gap-2">
                          <CheckCircle className="h-4 w-4"/> No major grammar errors found.
                        </p>
                      )}
                      
                      {/* Language Rubric Comment */}
                      <div className="mt-4 pt-4 border-t border-red-50">
                        <p className="text-xs text-gray-500 uppercase font-bold mb-1">Structural Feedback</p>
                        <p className="text-sm text-gray-700">{feedback.sentenceStructure}</p>
                      </div>
                   </div>
                </div>

                {/* Right Col: Content & Style */}
                <div className="space-y-4">
                   {/* Content / Relevance */}
                   <div className="bg-white p-5 rounded-lg border border-blue-100 shadow-sm">
                      <h3 className="font-bold text-blue-700 uppercase text-xs tracking-wider mb-3 flex items-center gap-2">
                        <ClipboardCheck className="h-4 w-4"/> Content & Relevance
                      </h3>
                      <p className="text-sm text-gray-700 leading-relaxed">{feedback.relevance}</p>
                      
                      <div className="mt-3 pt-3 border-t border-blue-50">
                         <h4 className="text-xs font-bold text-purple-600 uppercase mb-1 flex items-center gap-1">
                           <Sparkles className="h-3 w-3"/> Creativity
                         </h4>
                         <p className="text-sm text-gray-600">{feedback.creativity}</p>
                      </div>
                   </div>

                   {/* Vocabulary */}
                   <div className="bg-white p-5 rounded-lg border border-orange-100 shadow-sm">
                      <h3 className="font-bold text-orange-700 uppercase text-xs tracking-wider mb-3 flex items-center gap-2">
                        <BookOpen className="h-4 w-4"/> Vocabulary
                      </h3>
                      <p className="text-sm text-gray-700">{feedback.vocabularyUsage}</p>
                   </div>
                </div>
             </div>
          </div>
        )}

      </main>

      <footer className="max-w-4xl mx-auto mt-8 text-center text-gray-400 text-sm">
        <p>Powered by Google Gemini 2.5 Flash & Flash Image</p>
      </footer>

      {/* History Modal */}
      {showHistory && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl flex flex-col max-h-[80vh]">
            <div className="p-4 border-b flex justify-between items-center">
              <h2 className="text-xl font-bold font-serif flex items-center gap-2">
                <HistoryIcon className="text-blue-600"/> Saved Stories
              </h2>
              <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600">
                <X className="h-6 w-6" />
              </button>
            </div>
            
            <div className="overflow-y-auto p-4 space-y-3 flex-1">
              {savedSessions.length === 0 ? (
                <p className="text-center text-gray-500 py-8 italic">No saved stories found.</p>
              ) : (
                savedSessions.map((session) => (
                  <div key={session.id} className="border rounded-lg p-3 hover:bg-gray-50 transition-colors flex gap-4">
                    {/* Thumbnail */}
                    <div className="w-20 h-20 bg-gray-200 rounded overflow-hidden flex-shrink-0 border">
                      {session.generatedImages[0] ? (
                        <img src={session.generatedImages[0]} alt="Thumbnail" className="w-full h-full object-cover grayscale" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-xs text-gray-400">No img</div>
                      )}
                    </div>
                    
                    {/* Content */}
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-start">
                        <h3 className="font-bold text-sm truncate pr-2">{session.scenario.title}</h3>
                        <span className="text-xs font-mono bg-gray-200 px-1.5 py-0.5 rounded text-gray-600">
                          {session.difficulty}
                        </span>
                      </div>
                      <p className="text-xs text-gray-500 mt-1">
                        {new Date(session.timestamp).toLocaleDateString()} at {new Date(session.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                      </p>
                      <p className="text-xs text-gray-400 mt-1 truncate">
                        {session.studentText ? `"${session.studentText.substring(0, 30)}..."` : "No writing yet"}
                      </p>
                      {session.feedback && (
                         <span className="text-xs text-green-600 font-bold block mt-1">
                           Score: {session.feedback.score}/{session.feedback.maxScore || (session.difficulty === 'P5' ? 7 : 6)}
                         </span>
                      )}
                    </div>

                    {/* Actions */}
                    <div className="flex flex-col justify-between items-end">
                       <button 
                        onClick={() => loadSession(session)}
                        className="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                       >
                         Load
                       </button>
                       <button 
                        onClick={() => deleteSession(session.id)}
                        className="text-gray-400 hover:text-red-500 p-1"
                       >
                         <Trash2 className="h-4 w-4" />
                       </button>
                    </div>
                  </div>
                ))
              )}
            </div>
            
            <div className="p-3 bg-gray-50 border-t text-center text-xs text-gray-400">
              Saved locally in your browser. Large images supported via IndexedDB.
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
